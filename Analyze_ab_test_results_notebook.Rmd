---
title: "Analyze A/B Test Results"
output: html_notebook
---

```{r}
library(boot)
library(dplyr)
library(ggplot2)
library(microbenchmark)
library(readr)
library(tibble)
```

## Wrangle

## Gather and Assess

```{r}
tbl <- read_csv("ab_data.csv")
```

```{r}
head(tbl)
```

```{r}
records <- nrow(tbl)
records
```

```{r}
# Number of records with unique users
records_unique_usr <- length(unique(tbl$user_id))
records_unique_usr
```

```{r}
records_non_unique_usr <- records - records_unique_usr
records_non_unique_usr
```

There are 3894 records with non-unique user IDs.

```{r}
# Preview records with non-unique user IDs
tbl %>%
  filter(duplicated(user_id) | duplicated(user_id, fromLast = TRUE)) %>%
  arrange(user_id) %>%
  slice_head(n = 10)
```

The redundant user IDs have mismatched records! For instance, user `630052` is
part of the `treatment` group. As such, this user should have been served the
`new_page`. Yet user `630052` is recorded as having received both. Similarly,
user `630320` is recorded as being part of the `control` group _and_ the
`treatment` group. So in which group is the user? In both instances, user
`630320` is said to have landed on the `old_page`, which should have been served to the `control` group.

```{r}
treat_old <- tbl %>%
  filter(group == "treatment" & landing_page != "new_page")

nrow(treat_old)
```

```{r}
ctrl_new <- tbl %>%
  filter(group == "control" & landing_page != "old_page")

nrow(ctrl_new)
```

```{r}
mismatch <- bind_rows(treat_old, ctrl_new)
mismatch_cnt <- nrow(mismatch)

mismatch_cnt
```

```{r}
records_non_unique_usr - mismatch_cnt
```

All but _one_ of the non-unique user IDs are due to redundant, mismatched
record pairs.

```{r}
# Return non-unique user IDs _not_ due to redundant, mismatched record pairs.
tbl %>%
  anti_join(mismatch) %>%
  filter(duplicated(user_id) | duplicated(user_id, fromLast = TRUE))
```

```{r}
# Test whether there are any missing values in the data frame as a whole.
colSums(is.na(tbl)) > 0
```

## Clean

### Issue 1: There are 3893 redundant user IDs having mismatched records.

The `control` group should be served the `old_page`, and the `new_group` should
be served the `new_page`.

#### Define: Filter for the properly matched results, storing them in a new data frame.

#### Code

```{r}
tbl_2 <- tbl %>%
  filter(
    (group == "control" & landing_page == "old_page") |
    (group == "treatment" & landing_page == "new_page")
  )
```

#### Test

```{r}
tbl_2 %>%
  filter(
    (group == "control" & landing_page != "old_page") |
    (group == "treatment" & landing_page != "new_page")
  )
```

### Issue 2: There is one other non-unique user ID.

Note: The two records have different timestamps. Since the variables of
interest are `group`, `landing_page`, and `conversion`, one of the records can
be dropped.

#### Define: Drop one of the records.

#### Code

```{r}
tbl_2 <- tbl_2 %>%
  distinct(user_id, .keep_all = TRUE)
```

#### Test

```{r}
tbl_2 %>%
  filter(duplicated(user_id) | duplicated(user_id, fromLast = TRUE))
```

## Analyze

### Describe: Probability

```{r}
# Overall probability of a user converting
p_pop <- mean(tbl_2$converted)
p_pop
```

```{r}
tbl_2_ctrl <- tbl_2 %>%
  filter(group == "control")
ctrl_cnvt_prob <- mean(tbl_2_ctrl$converted)

ctrl_cnvt_prob
```

```{r}
tbl_2_treat <- tbl_2 %>%
  filter(group == "treatment")
treat_cnvt_prob <- mean(tbl_2_treat$converted)

treat_cnvt_prob
```

```{r}
# Calculate the actual difference (obs_diff) between the conversion rates for
# the two groups.
obs_diff <- treat_cnvt_prob - ctrl_cnvt_prob
obs_diff
```

<sup>Note: `control` is subtracted from `treatment` to show how exposure to the
new landing page affects the outcome of interest `conversion`: thus, a negative
number indicates a lower probability of conversion, and a positive number
indicates a higher probability.</sup>

The conversion rate for the treatment group was lower--albeit by only 0.0016.

### A/B Test

As a starting point, let us assume that the `old_page` is better ($H_0$). To
accept the `new_page` as better ($H_1$), we would require conclusive evidence
with, say, a 95% chance of being right--ie a 5% chance of being wrong ($Î±$ =
0.05).

$$
H_0: p_{new} - p_{old} \leq 0\\ H_1: p_{new} - p_{old} > 0
$$
Under the null hypothesis $H_0$, our aforementioned starting point, we assume
that $p_{new}$ and $p_{old}$ are equal for the purposes of the experiment.
Further, we assume that both are equal to $p_{pop}$, the overall probability of
a user converting across our population `tbl_2`. Basically, we assume the
landing page served makes no difference.

$$
p_{new} = p_{old} = p_{pop}
$$
#### Bootstrap
##### Resample

```{r}
ab_test_bootfun <- function(data, indices) {
  sample_ctrl <- data[indices, ]
  sample_treat <- data[-indices, ]
  # Probability of a user converting for the bootstrap samples
  sample_ctrl_cnvt_prob <- mean(sample_ctrl$converted)
  sample_treat_cnvt_prob <- mean(sample_treat$converted)
  # Calculate the difference between the conversion rates
  p_diffs <- sample_treat_cnvt_prob - sample_ctrl_cnvt_prob
  return(p_diffs)
}
```

```{r}
set.seed(42)
```

```{r}
reps <- boot(data = tbl_2, statistic = ab_test_bootfun, R = 1000)
```

```{r}
# P-value
mean(reps$t > obs_diff)
```